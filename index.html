<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSE Checker</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #f0f2f5; margin: 0; padding: 20px; }
      .container { max-width: 500px; width: 100%; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
      .camera-container { position: relative; width: 100%; padding-top: 75%; /* 4:3 Aspect Ratio */ background: #000; border-radius: 8px; overflow: hidden; margin-bottom: 15px; }
        video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
      .controls { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
      .language-selector { display: flex; justify-content: center; gap: 10px; }
        button { padding: 12px 20px; font-size: 16px; border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; }
        #captureButton { background-color: #007bff; color: white; width: 100%; }
        #captureButton:disabled { background-color: #a0a0a0; }
      .lang-btn { background-color: #e9ecef; color: #495057; }
      .lang-btn.active { background-color: #28a745; color: white; }
      .result-box { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; min-height: 100px; white-space: pre-wrap; text-align: right; }
        [dir="ltr"].result-box { text-align: left; }
    </style>
</head>
<body>

    <div class="container">
        <h1>HSE Compliance Checker</h1>
        
        <div class="camera-container">
            <video id="video" autoplay playsinline muted></video>
            <canvas id="canvas" style="display:none;"></canvas>
        </div>

        <div class="controls">
            <div class="language-selector">
                <button id="lang-ar" class="lang-btn active">العربية</button>
                <button id="lang-fr" class="lang-btn">Français</button>
            </div>
            <button id="captureButton">التقاط وتحليل</button>
        </div>

        <div id="resultDiv" class="result-box">النتائج ستظهر هنا...</div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const captureButton = document.getElementById('captureButton');
        const resultDiv = document.getElementById('resultDiv');
        const langArButton = document.getElementById('lang-ar');
        const langFrButton = document.getElementById('lang-fr');
        const context = canvas.getContext('2d');

        let currentLanguage = 'ar';

        // تشغيل الكاميرا
        navigator.mediaDevices.getUserMedia({ video: true })
          .then(stream => {
                video.srcObject = stream;
            })
          .catch(err => {
                console.error("Error accessing webcam:", err);
                resultDiv.textContent = "خطأ في الوصول إلى الكاميرا.";
            });

        // تبديل اللغة
        langArButton.addEventListener('click', () => setLanguage('ar'));
        langFrButton.addEventListener('click', () => setLanguage('fr'));

        function setLanguage(lang) {
            currentLanguage = lang;
            const isArabic = lang === 'ar';
            
            document.documentElement.lang = lang;
            document.documentElement.dir = isArabic? 'rtl' : 'ltr';

            langArButton.classList.toggle('active', isArabic);
            langFrButton.classList.toggle('active',!isArabic);

            captureButton.textContent = isArabic? 'التقاط وتحليل' : 'Capturer et Analyser';
            resultDiv.textContent = isArabic? 'النتائج ستظهر هنا...' : 'Les résultats apparaîtront ici...';
        }

        // التقاط الصورة وتحليلها
        captureButton.addEventListener('click', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            canvas.toBlob(blob => {
                analyzeImage(blob);
            }, 'image/jpeg');
        });

        async function analyzeImage(imageBlob) {
            const formData = new FormData();
            formData.append('image', imageBlob, 'capture.jpg');
            // لا نرسل اللغة هنا، لأن الواجهة الخلفية ستعطينا دائماً JSON
            // formData.append('targetLanguage', currentLanguage);

            captureButton.disabled = true;
            resultDiv.textContent = currentLanguage === 'ar'? 'جاري التحليل...' : 'Analyse en cours...';

            try {
                // اسم الدالة يجب أن يكون مطابقاً لاسم الملف
                const response = await fetch('/api/analyzeimage', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const errorResult = await response.json();
                    throw new Error(errorResult.error |

| 'Server error');
                }

                const data = await response.json();
                
                let resultText = '';
                if (currentLanguage === 'fr') {
                    resultText = 'Rapport détaillé:\n\n';
                    resultText += `- Charlotte: ${data.charlotte? '✔️ Portée' : '❌ Non détectée'}\n`;
                    resultText += `- Masque: ${data.bavette? '✔️ Porté' : '❌ Non détecté'}\n`;
                    resultText += `- Combinaison: ${data.suit? '✔️ Portée' : '❌ Non détectée'}\n`;
                } else {
                    resultText = 'تقرير مفصل:\n\n';
                    resultText += `- غطاء الشعر: ${data.charlotte? '✔️ مرتدى' : '❌ غير مرتدى'}\n`;
                    resultText += `- كمامة: ${data.bavette? '✔️ مرتدى' : '❌ غير مرتدى'}\n`;
                    resultText += `- بدلة واقية: ${data.suit? '✔️ مرتدى' : '❌ غير مرتدى'}\n`;
                }
                resultDiv.textContent = resultText;

            } catch (error) {
                console.error('Error:', error);
                resultDiv.textContent = `Error: ${error.message}`;
            } finally {
                captureButton.disabled = false;
            }
        }
    </script>

</body>
</html>
