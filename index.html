<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HSE Checker</title>
  
  <!-- 1. Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- 2. Google Font: Poppins -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- 3. React Libraries -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  
  <!-- 4. Babel (for JSX) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- 5. Lucide Icons -->
  <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.js"></script>

  <style>
    /* Injects the Poppins font into Tailwind */
    body, .font-poppins {
      font-family: 'Poppins', sans-serif;
    }
  </style>
</head>
<body>
  
  <!-- This is where our React app will live -->
  <noscript>You need to enable JavaScript to run this app.</noscript>
  <div id="root"></div>

  <!-- 6. Our Entire React Application Logic -->
  <script type="text/babel">
    
    // --- Font Injection Hook ---
    const useGoogleFont = (fontFamily) => {
      React.useEffect(() => {
        const styleId = 'font-poppins-style';
        if (document.getElementById(styleId)) return;
        
        const style = document.createElement('style');
        style.id = styleId;
        style.innerHTML = `
          .font-poppins { font-family: 'Poppins', sans-serif; }
        `;
        document.head.appendChild(style);
      }, [fontFamily]);
    };

    // --- Constants ---
    // !! IMPORTANT !!
    // !! قم بوضع مفتاح API الخاص بك هنا !!
    // !! YOU MUST ADD YOUR OWN GEMINI API KEY HERE !!
    const API_KEY = ""; // <--- أضف مفتاحك هنا
    // FIXED API URL
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
    const REQUIRED_PPE = ["hairnet", "mask", "suit", "gloves", "shoes"];

    // --- Translations ---
    const translations = {
      ar: {
        title: "HSE Checker",
        selectLang: "اختر لغتك",
        checkMe: "افحصني",
        homeGreeting: "مرحباً بك!",
        homeInstructions: "اضغط على الزر أدناه لفحص معدات الوقاية الشخصية (PPE) الخاصة بك.",
        takePhoto: "التقاط صورة",
        uploadGallery: "تحميل من المعرض",
        cancel: "إلغاء",
        analyzing: "جاري التحليل...",
        pleaseWait: "الرجاء الانتظار",
        analysisFailed: "فشل التحليل",
        tryAgain: "حاول مرة أخرى",
        detailedReport: "التقرير المفصل",
        checkAnother: "افحص صورة أخرى",
        compliantMessage: "جميع معدات الوقاية مطلوبة ومطابقة. يمكنك دخول خط الإنتاج.",
        nonCompliantMessage: "لا يمكنك دخول خط الإنتاج. يرجى التأكد من ارتداء جميع المعدات بشكل صحيح.",
        ppe_hairnet: "شارلوت للشعر",
        ppe_mask: "كمامة",
        ppe_suit: "البذلة المخصصة",
        ppe_gloves: "قفازات اليدين",
        ppe_shoes: "حذاء السلامة",
        analyzePrompt: "حلل معدات الوقاية الشخصية الخاصة بي.",
        goHome: "العودة للرئيسية",
        reason_correct: "تم ارتداؤه بشكل صحيح",
        reason_incorrect: "تم ارتداؤه بشكل غير صحيح",
        reason_missing: "مفقود / لم يتم العثور عليه",
        reason_not_visible: "غير مرئي للفحص", 
        error_api_key: "مفتاح API مفقود. يرجى إضافة مفتاح Gemini API الخاص بك." 
      },
      fr: {
        title: "HSE Checker",
        selectLang: "Choisissez votre langue",
        checkMe: "Vérifiez-moi",
        homeGreeting: "Bienvenue!",
        homeInstructions: "Appuyez sur le bouton ci-dessous pour vérifier votre équipement de protection individuelle (EPI).",
        takePhoto: "Prendre une photo",
        uploadGallery: "Importer de la galerie",
        cancel: "Annuler",
        analyzing: "Analyse en cours...",
        pleaseWait: "Veuillez patienter",
        analysisFailed: "L'analyse a échoué",
        tryAgain: "Réessayer",
        detailedReport: "Rapport Détaillé",
        checkAnother: "Vérifier une autre image",
        compliantMessage: "Tous les EPI requis sont correctement portés. Vous pouvez entrer sur la ligne de production.",
        nonCompliantMessage: "Vous ne pouvez pas entrer sur la ligne de production. Veuillez vous assurer que tous les EPI sont portés correctement.",
        ppe_hairnet: "Filet à cheveux",
        ppe_mask: "Masque",
        ppe_suit: "Combinaison de protection",
        ppe_gloves: "Gants",
        ppe_shoes: "Chaussures de sécurité",
        analyzePrompt: "Analysez mon EPI.",
        goHome: "Retour à l'accueil",
        reason_correct: "Porté correctement",
        reason_incorrect: "Porté incorrectement",
        reason_missing: "Manquant / Non trouvé",
        reason_not_visible: "Non visible pour inspection", 
        error_api_key: "Clé API manquante. Veuillez ajouter votre clé API Gemini." 
      }
    };

    // --- AI Configuration ---
    const SYSTEM_PROMPT = `**Role:** You are a hyper-vigilant AI Safety Inspector for a sterile pharmaceutical manufacturing facility. Your judgment is critical for preventing contamination. Failure is not an option.

    **Task:** Analyze the provided image of a worker. You must assess all 5 required PPE items.

    **Critical PPE & Strict Criteria:**

    1.  **Item: Hairnet (ID: "hairnet")**
        * **Observation:** Look at the head. Is all hair, including sideburns and fringe, completely covered by a hairnet?
        * **Status 'correct':** All hair is 100% contained.
        * **Status 'incorrect':** Any wisp of hair is visible.
        * **Status 'missing':** No hairnet is worn.

    2.  **Item: Mask (ID: "mask")**
        * **Observation:** Look at the face. Is a mask present? Does it create a seal over **both the nose and the mouth**?
        * **Status 'correct':** Mask is on, sealed over nose and mouth.
        * **Status 'incorrect':** Mask is present but worn improperly (e.g., under the nose, on the chin, large side gaps).
        * **Status 'missing':** No mask is visible on the face.

    3.  **Item: Protective suit (ID: "suit")**
        * **Observation:** Look at the torso, arms, and legs. Is the worker wearing a full-body protective suit (not just a lab coat)? Is it fully zipped/fastened?
        * **Status 'correct':** A full suit is worn and properly fastened.
        * **Status 'incorrect':** The suit is unzipped, torn, or clearly not a full-body suit.
        * **Status 'missing':** The worker is in street clothes or a partial garment.

    4.  **Item: Gloves (ID: "gloves")**
        * **Observation:** Look at **both hands**. Are they visible? Are both covered by gloves? Do the gloves overlap the suit's cuffs?
        * **Status 'correct':** Both visible hands are gloved, and cuffs are covered.
        * **Status 'incorrect':** Gloves are on but torn, or do not cover the suit cuffs.
        * **Status 'missing':** One or both visible hands are bare.
        * **Special Case:** If one or both hands are **not visible** in the image, you cannot confirm. Use status **'incorrect'** and reason "Hand(s) not visible for inspection".

    5.  **Item: Safety shoes / Shoe covers (ID: "shoes")**
        * **Observation:** Look at **both feet**. Are they visible? Are they covered by dedicated safety shoes or disposable shoe covers?
        * **Status 'correct':** Both visible feet are properly covered.
        * **Status 'incorrect':** Covers are worn improperly, or non-sterile shoes (like sneakers) are visible.
        * **Status 'missing':** Feet are bare or in non-compliant footwear.
        * **Special Case:** If one or both feet are **not visible** in the image, you cannot confirm. Use status **'incorrect'** and reason "Feet not visible for inspection".

    **Output Format:**
    You MUST provide an entry for ALL 5 items.
    'compliant' is ONLY if ALL 5 items have a status of "correct".
    You MUST return your analysis in the specified JSON format.`;

    const RESPONSE_SCHEMA = {
      type: "OBJECT",
      properties: {
        "ppeItems": {
          type: "ARRAY",
          items: {
            type: "OBJECT",
            properties: {
              "id": { type: "STRING" },
              "status": { type: "STRING" },
              "reason": { type: "STRING" }
            }
          }
        },
        "overallStatus": { type: "STRING" }
      }
    };

    // --- Helper Functions ---
    const fileToDataURL = (file) => (
      new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = (error) => reject(error);
        reader.readAsDataURL(file);
      })
    );

    const retryWithBackoff = async (fn, maxRetries = 5, delay = 1000) => {
      let attempt = 0;
      while (attempt < maxRetries) {
        try {
          return await fn();
        } catch (error) {
          if (attempt === maxRetries - 1) throw error;
          attempt++;
          await new Promise((resolve) => setTimeout(resolve, delay * Math.pow(2, attempt)));
        }
      }
    };

    // --- UI Components ---
    // Using lucide.Loader2, lucide.AlertTriangle etc. directly

    const LoadingSpinner = ({ t }) => (
      <div className="flex flex-col items-center justify-center my-24" role="status" aria-label={t('analyzing')}>
        <lucide.Loader2 className="animate-spin text-rose-600" size={64} />
        <p className="mt-6 text-xl text-gray-700 font-semibold">{t('analyzing')}</p>
        <p className="text-lg text-gray-500">{t('pleaseWait')}</p>
      </div>
    );

    const ErrorMessage = ({ error, onReset, t }) => (
      <div className="my-10 p-5 bg-red-50 border border-red-300 text-red-800 rounded-2xl shadow-md" role="alert">
        <div className="flex items-center">
          <lucide.AlertTriangle className="h-7 w-7 me-3" />
          <p className="font-bold text-xl">{t('analysisFailed')}</p>
        </div>
        <p className="mt-3 text-md">{error}</p>
        <button
          onClick={onReset}
          className="w-full mt-6 bg-gradient-to-r from-red-600 to-rose-700 hover:from-red-700 hover:to-rose-800 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-all duration-300 transform hover:-translate-y-0.5"
        >
          {t('tryAgain')}
        </button>
      </div>
    );

    const ReportItem = ({ item, t }) => {
      const isCorrect = item.status === 'correct';
      const Icon = isCorrect ? lucide.CheckCircle2 : lucide.XCircle;
      const color = isCorrect ? 'text-green-600' : 'text-red-600';
      
      let reasonText;
      if (item.reason && (item.reason.includes("not visible") || item.reason.includes("غير مرئي"))) {
        reasonText = t('reason_not_visible');
      } else {
        reasonText = t(`reason_${item.status}`);
      }


      return (
        <li className="flex items-start p-5 bg-white shadow-xl rounded-2xl border border-gray-100">
          <div className="flex-shrink-0 mt-1">
            <Icon className={color} size={30} aria-hidden="true" />
          </div>
          <div className="ms-4 flex-1">
            <p className={`text-xl font-bold ${color}`}>{item.name}</p>
            <p className="text-md text-gray-700">{reasonText}</p>
          </div>
        </li>
      );
    };

    const ResultDisplay = ({ image, result, onReset, t }) => {
      const isCompliant = result.overallStatus === 'compliant';
      const statusColor = isCompliant ? 'bg-green-50 border-green-300 text-green-800' : 'bg-red-50 border-red-300 text-red-800';
      const statusIcon = isCompliant ? <lucide.CheckCircle2 size={32} /> : <lucide.XCircle size={32} />;

      return (
        <div className="w-full">
          <div className="w-full rounded-3xl overflow-hidden shadow-2xl border-4 border-white mb-8">
            <img src={image} alt="Analyzed worker" className="w-full h-auto" />
          </div>

          <div className={`mt-6 p-5 rounded-2xl border-2 ${statusColor} flex items-center justify-center shadow-lg`}>
            <div className="flex-shrink-0 mx-3">
              {statusIcon}
            </div>
            <p className="font-bold text-center text-lg">{result.summaryMessage}</p>
          </div>
          
          <div className="mt-10">
            <h2 className="text-3xl font-extrabold text-gray-900 mb-6">{t('detailedReport')}</h2>
            <ul className="space-y-4">
              {result.ppeItems.map((item, index) => (
                <ReportItem key={item.id || index} item={item} t={t} />
              ))}
            </ul>
          </div>

          <button
            onClick={onReset}
            className="w-full mt-12 bg-gradient-to-r from-rose-600 to-red-600 hover:from-rose-700 hover:to-red-700 text-white font-bold py-4 px-4 rounded-2xl text-xl shadow-lg transition-all duration-300 transform hover:-translate-y-1 focus:outline-none focus:ring-4 focus:ring-rose-300"
          >
            {t('checkAnother')}
          </button>
        </div>
      );
    };

    const LanguageSelectionScreen = ({ onSelect }) => {
      useGoogleFont('Poppins'); // Ensure font is active

      return (
        <div className="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-4 font-poppins">
          <div className="bg-white p-10 rounded-3xl shadow-2xl text-center max-w-sm w-full">
            <lucide.Languages className="text-rose-600 mx-auto" size={64} />
            <h1 className="text-3xl font-bold text-gray-800 mt-6 mb-2">اختر لغتك</h1>
            <h1 className="text-3xl font-bold text-gray-800 mb-10">Choisissez votre langue</h1>
            <button
              onClick={() => onSelect('ar')}
              className="w-full bg-gradient-to-r from-rose-600 to-red-600 hover:from-rose-700 hover:to-red-700 text-white font-bold py-4 px-4 rounded-2xl text-xl shadow-lg transition-all duration-300 transform hover:-translate-y-1 mb-5"
            >
              العربية
            </button>
            <button
              onClick={() => onSelect('fr')}
              className="w-full bg-gray-700 hover:bg-gray-800 text-white font-bold py-4 px-4 rounded-2xl text-xl shadow-lg transition-all duration-300 transform hover:-translate-y-1"
            >
              Français
            </button>
          </div>
        </div>
      );
    };

    const Header = ({ t, lang, onResetHome }) => (
      <header className="text-center py-7 px-4 bg-gradient-to-r from-rose-600 to-red-600 text-white shadow-lg rounded-b-3xl relative">
        <h1 className="text-4xl font-extrabold tracking-tight">{t('title')}</h1>
        <button
          onClick={onResetHome}
          className={`absolute top-1/2 -translate-y-1/2 text-white opacity-80 hover:opacity-100 transition-opacity p-2 rounded-full hover:bg-white hover:bg-opacity-20`}
          style={lang === 'ar' ? { left: '15px' } : { right: '15px' }}
          aria-label={t('goHome')}
        >
          <lucide.Home size={30} />
        </button>
      </header>
    );

    const HomeScreen = ({ t, onCheck }) => (
      <div className="flex flex-col items-center justify-center text-center p-6" style={{ minHeight: 'calc(100vh - 104px)' }}>
        <h2 className="text-4xl font-bold text-gray-900 mb-5">{t('homeGreeting')}</h2>
        <p className="text-xl text-gray-600 mb-14 max-w-xs">{t('homeInstructions')}</p>
        <button
          onClick={onCheck}
          aria-label={t('checkMe')}
          className="bg-gradient-to-br from-rose-600 to-red-600 text-white font-bold w-64 h-64 rounded-full text-5xl shadow-2xl flex items-center justify-center transition-all duration-300 ease-in-out transform hover:scale-110 active:scale-105 focus:outline-none focus:ring-4 focus:ring-rose-300"
        >
          {t('checkMe')}
        </button>
      </div>
    );

    const UploadOptionsModal = ({ t, isVisible, onClose, onCamera, onGallery }) => {
      if (!isVisible) return null;

      return (
        <div 
          className="fixed inset-0 bg-black bg-opacity-60 z-40 flex justify-center items-end"
          onClick={onClose}
          role="dialog"
          aria-modal="true"
        >
          <div 
            className="bg-white w-full max-w-md rounded-t-3xl shadow-xl p-7 z-50"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="flex justify-between items-center mb-8">
               <h3 className="text-3xl font-bold text-gray-900">{t('checkMe')}</h3>
               <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                 <lucide.X size={32} />
               </button>
            </div>
            <button
              onClick={onCamera}
              className="w-full flex items-center justify-center gap-4 bg-gradient-to-r from-rose-600 to-red-600 hover:from-rose-700 hover:to-red-700 text-white font-bold py-4 px-4 rounded-2xl text-xl shadow-lg transition-all duration-300 transform hover:-translate-y-1 mb-5"
            >
              <lucide.Camera size={26} />
              {t('takePhoto')}
            </button>
            <button
              onClick={onGallery}
              className="w-full flex items-center justify-center gap-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-4 px-4 rounded-2xl text-xl shadow-lg transition-all duration-300 transform hover:-translate-y-1"
            >
              <lucide.Image size={26} />
              {t('uploadGallery')}
            </button>
          </div>
        </div>
      );
    };

    const AnalysisScreen = ({ isLoading, error, image, result, t, onReset }) => (
      <div className="p-5">
        {isLoading && <LoadingSpinner t={t} />}
        {error && !isLoading && <ErrorMessage error={error} onReset={onReset} t={t} />}
        {image && result && !isLoading && !error && (
          <ResultDisplay image={image} result={result} onReset={onReset} t={t} />
        )}
      </div>
    );

    // --- Main App Component Definition ---
    // (This function is now defined but NOT executed yet)
    function App() {
      const [lang, setLang] = React.useState(null); 
      const [currentView, setCurrentView] = React.useState('home'); 
      const [showUploadOptions, setShowUploadOptions] = React.useState(false);
      const [image, setImage] = React.useState(null);
      const [analysisResult, setAnalysisResult] = React.useState(null);
      const [isLoading, setIsLoading] = React.useState(false);
      const [error, setError] = React.useState(null);

      const fileInputCameraRef = React.useRef(null);
      const fileInputGalleryRef = React.useRef(null);

      useGoogleFont('Poppins');

      const t = React.useCallback((key) => translations[lang]?.[key] || key, [lang]);

      const handleLangSelect = (selectedLang) => {
        setLang(selectedLang);
      };

      const resetApp = () => {
        setImage(null);
        setAnalysisResult(null);
        setIsLoading(false);
        setError(null);
        setShowUploadOptions(false);
        setCurrentView('home');
        if (fileInputCameraRef.current) fileInputCameraRef.current.value = "";
        if (fileInputGalleryRef.current) fileInputGalleryRef.current.value = "";
      };

      const handleImageChange = async (event) => {
        const file = event.target.files?.[0];
        if (!file) return;

        setImage(null);
        setAnalysisResult(null);
        setError(null);
        setIsLoading(true);
        setShowUploadOptions(false);
        setCurrentView('analysis');

        try {
          if (!API_KEY) {
            setError(t('error_api_key'));
            setIsLoading(false);
            return;
          }
          
          const dataUrl = await fileToDataURL(file);
          setImage(dataUrl);
          const base64Data = dataUrl.split(',')[1];
          await analyzeImage(base64Data, file.type);
        } catch (err) {
          console.error("Image processing error:", err);
          setError(`Failed to read image. Please try again. ${err.message}`);
          setIsLoading(false);
        }
      };

      const analyzeImage = React.useCallback(async (base64ImageData, mimeType) => {
        const payload = {
          contents: [
            { role: "user", parts: [
                { text: t('analyzePrompt') },
                { inlineData: { mimeType: mimeType, data: base64ImageData } }
            ]}
          ],
          systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] },
          generationConfig: {
            responseMimeType: "application/json",
            responseSchema: RESPONSE_SCHEMA
          }
        };

        try {
          const apiCall = async () => {
            const response = await fetch(API_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            if (!response.ok) {
              const errorBody = await response.text();
              console.error("API Error Body:", errorBody);
              throw new Error(`API Error: ${response.status} ${response.statusText}`);
            }
            return response.json();
          };

          const result = await retryWithBackoff(apiCall);
          
          const candidate = result.candidates?.[0];
          if (candidate && candidate.content?.parts?.[0]?.text) {
            const jsonText = candidate.content.parts[0].text;
            const parsedJson = JSON.parse(jsonText);
            const reportedItems = parsedJson.ppeItems || [];
            
            const finalPpeItems = REQUIRED_PPE.map(id => {
              const foundItem = reportedItems.find(item => item.id === id);
              if (foundItem) {
                return { ...foundItem, name: t(`ppe_${id}`) };
              }
              return {
                id: id,
                name: t(`ppe_${id}`),
                status: "missing",
                reason: "Item not detected in image.",
              };
            });

            const isNonCompliant = finalPpeItems.some(item => item.status !== 'correct');
            const finalStatus = isNonCompliant ? "non-compliant" : "compliant";
            const finalMessage = t(isNonCompliant ? 'nonCompliantMessage' : 'compliantMessage');

            setAnalysisResult({
              ppeItems: finalPpeItems,
              overallStatus: finalStatus,
              summaryMessage: finalMessage
            });

          } else {
            console.error("Invalid response from AI:", result);
            throw new Error("Invalid response structure from AI.");
          }
        } catch (err) {
          console.error("AI analysis error:", err);
          setError(`${err.message}. Please try again.`);
        } finally {
          setIsLoading(false);
        }
      }, [lang, t]);

      // Check for dependencies *inside* the render
      if (!window.React || !window.ReactDOM || !window.lucide) {
        return (
          <div style={{ padding: '20px', fontFamily: 'sans-serif', color: 'red', textAlign: 'center' }}>
            Error: Core libraries (React, ReactDOM, Lucide) failed to load. <br/> Please check your internet connection and refresh.
          </div>
        );
      }
      
      if (!lang) {
        return <LanguageSelectionScreen onSelect={handleLangSelect} />;
      }

      const dir = lang === 'ar' ? 'rtl' : 'ltr';

      return (
        <div className="bg-gray-100 min-h-screen font-poppins" dir={dir}>
          <div className="container max-w-md mx-auto bg-gray-50 min-h-screen shadow-2xl">
            <Header t={t} lang={lang} onResetHome={resetApp} />
            
            <main>
              {currentView === 'home' && (
                <HomeScreen t={t} onCheck={() => setShowUploadOptions(true)} />
              )}
              {currentView === 'analysis' && (
                <AnalysisScreen
                  isLoading={isLoading}
                  error={error}
                  image={image}
                  result={analysisResult}
                  t={t}
                  onReset={resetApp}
                />
              )}
            </main>
          </div>

          <UploadOptionsModal
            t={t}
            isVisible={showUploadOptions}
            onClose={() => setShowUploadOptions(false)}
            onCamera={() => fileInputCameraRef.current.click()}
            onGallery={() => fileInputGalleryRef.current.click()}
          />

          {/* Hidden File Inputs */}
          <input
            type="file"
            ref={fileInputCameraRef}
            onChange={handleImageChange}
            className="hidden"
            accept="image/*"
            capture="environment"
          />
          <input
            type="file"
            ref={fileInputGalleryRef}
            onChange={handleImageChange}
            className="hidden"
            accept="image/*"
          />
        </div>
      );
    }
    
  </script>
  
  <!-- 7. Mount the App only after all resources are loaded -->
  <script type="text/babel">
    window.addEventListener('load', () => {
      // All scripts (React, Lucide) are loaded now.
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(React.createElement(App));
    });
  </script>
  
</body>
</html>


